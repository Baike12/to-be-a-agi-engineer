# 1	mysql数据文件
一个库是一个文件夹
一个表包含三个文件，8.0版本合并成一个ibd了
# 2	ibd文件
![[Pasted image 20240917161049.png]]
## 2.1	行
一条记录的形式
## 2.2	页
一次加载的大小
### 2.2.1	种类
有数据页、undo页、溢出页等
## 2.3	区
一块1m大小连续存储，对于大数据表，将表的数据放到内存的一个区中，避免随机io
## 2.4	段
分为三种段
### 2.4.1	数据段
索引的叶子节点
### 2.4.2	索引段
索引的非叶子节点
### 2.4.3	回滚段
用于事务回滚

# 3	行格式
有四种，但是5.x版本主要用compact，8.x主要用dynamic，dynamic是基于compact改进的
## 3.1	dynamic
![[Pasted image 20240917165220.png]]
### 3.1.1	变长字段
逆序存放变长字段长度，为什么是逆序？
- 使得数据和长度可以在一个cpu 的cacheline中
对于没有变长字段的表，没有变长字段列表
### 3.1.2	null值列表
用位图表示，位图大小是整字节数，也是逆序的
也不是必须的，创建表时使用not null就指定该字段不会是null，至少节省1个位:)
### 3.1.3	记录头信息（5字节）
- 是否删除标识
- 下一条记录位置
- 记录类型：0：普通记录、1：b+树非叶子节点记录、2：最小记录，3：最大记录
### 3.1.4	记录数据
- row_id：没有主键或者约束列时自动生成的列，6字节
- trx_id：哪一个事务生成的，必须，6字节
- roll_ptr：记录的上一个版本，必须，7字节
### 3.1.5	记录
- 一行不能超过65535字节，除了text、blob等
### 3.1.6	溢出处理
一页16k，才16384字节，一行可以容纳65535字节，溢出的会被放到溢出页，然后在行中只存放一部分数据，用一个20字节的指针指向溢出页地址，
dynamic和compact的区别就在这，dynamic有溢出的行，行中不存放数据，只存放指针

# 4	页格式
默认16k，页中数据按主键顺序组织的单向链表
![[Pasted image 20240918110253.png]]
## 4.1	文件头
页信息
有两个指针分别指向前后数据页
## 4.2	页头
页状态信息
## 4.3	页目录
避免查询时要遍历整个页
将页中数据分组，页目录条目记录每一个分组中最后一个数据的偏移，查找数据时先二分法找到中间组的最后一个数据的值与要查找的值比较，然后继续二分法知道找到对应的组，再在组里遍历
组内最后一条数据的n_owned字段记录组内有多少数据
![[Pasted image 20240918112225.png]]
### 4.3.1	分组限制：
- 第一个分组只能有一条
- 最后一个分组在1-8条之间
- 中间分组在4-8条之间
# 5	索引查找
- 先通过主键在非叶子节点找到页，因为页内包含主键的最大最小值
- 再到叶子节点内找到对应的组
- 遍历组找到数据
# 6	b+树
比b树好：
- 增删效率：节点冗余，增删的时候变动小，特别是删除叶子节点甚至不需要变动树结构
- 范围查询：b+树叶子节点是链表
